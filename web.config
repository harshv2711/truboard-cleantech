<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <!-- Security Headers -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
        <add name="Permissions-Policy" value="geolocation=(), microphone=(), camera=()" />
      </customHeaders>
    </httpProtocol>

    <!-- URL Rewrite Rules -->
    <rewrite>
      <rules>
        <!-- 1. Force HTTPS -->
        <rule name="Force HTTPS" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect"
                  url="https://{HTTP_HOST}/{R:1}"
                  redirectType="Permanent" />
        </rule>

        <!-- 2. Redirect www to non-www -->
        <rule name="Redirect WWW to non-www" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTP_HOST}"
                 pattern="^www\.truboardcleantech\.com$"
                 ignoreCase="true" />
          </conditions>
          <action type="Redirect"
                  url="https://truboardcleantech.com/{R:1}"
                  redirectType="Permanent" />
        </rule>

        <!-- 3. Remove index.html - Fixed to prevent loops -->
        <rule name="Remove index.html" stopProcessing="true">
          <match url="^(.*)index\.html$" ignoreCase="true" />
          <conditions>
            <add input="{REQUEST_METHOD}" pattern="GET" ignoreCase="true" />
          </conditions>
          <action type="Redirect"
                  url="https://truboardcleantech.com/{R:1}"
                  redirectType="Permanent" />
        </rule>

        <!-- 4. Allow robots.txt but block other sensitive files -->
        <rule name="Allow robots.txt" stopProcessing="true">
          <match url="^robots\.txt$" ignoreCase="true" />
          <action type="None" />
        </rule>

        <!-- 5. Block access to sensitive files (excluding robots.txt) -->
        <rule name="Block sensitive files" stopProcessing="true">
          <match url="^(.*\.(config|log|md|json|lock|git|vscode|htaccess|htpasswd))$" ignoreCase="true" />
          <action type="CustomResponse" statusCode="404" statusReason="Not Found" statusDescription="File not found" />
        </rule>

        <!-- 6. Block PHP files (since this is static HTML site) -->
        <rule name="Block PHP files" stopProcessing="true">
          <match url="^.*\.php$" ignoreCase="true" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/(send-|contact-|mail\.php)" negate="true" />
          </conditions>
          <action type="CustomResponse" statusCode="404" statusReason="Not Found" statusDescription="File not found" />
        </rule>

        <!-- 7. Block specific test and development files -->
        <rule name="Block test files" stopProcessing="true">
          <match url="^(test\.html|test\.php|test-.*\.html|vendor/.*|mails/smtp\.php)$" ignoreCase="true" />
          <action type="CustomResponse" statusCode="404" statusReason="Not Found" statusDescription="File not found" />
        </rule>

        <!-- 8. Canonical trailing slash removal -->
        <rule name="Remove trailing slash" stopProcessing="true">
          <match url="(.*)/$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Redirect" 
                  url="{R:1}" 
                  redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>

    <!-- Default Document Settings -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.html" />
      </files>
    </defaultDocument>

    <!-- Compression -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    <httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files">
      <scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" />
      <staticTypes>  
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="*/*" enabled="false" />
      </staticTypes>
    </httpCompression>
  </system.webServer>
</configuration>